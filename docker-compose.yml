version: '3.8'

services:
  # MongoDB service with health check
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    ports:
      - "27017:27017"  # Exposing MongoDB to the host on port 27017
    volumes:
      - /home/ubuntu/mongo_data:/data/db  # Persistent data storage
    restart: always
    networks:
      - famlink-net  # Ensure the backend can communicate with MongoDB
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.runCommand('ping')"]
      interval: 30s      # Run the health check every 30 seconds
      retries: 5         # Retry 5 times before marking unhealthy
      start_period: 60s  # Give MongoDB 60 seconds to start
      timeout: 20s       # Timeout after 20 seconds if no response

  # Express backend service
  backend:
    build: .
    container_name: famlink-backend
    ports:
      - "4000:4000"  # Exposing the backend API on port 4000
    env_file:
      - .env  # Load environment variables from .env file
    environment:
      - MONGO_URI=${MONGO_URI}  # Fetch the MongoDB URI from .env file
    depends_on:
      mongodb:
        condition: service_healthy  # Wait for MongoDB to be healthy before starting the backend
    restart: always
    networks:
      - famlink-net  # Ensure both services can communicate

# Networks setup
networks:
  famlink-net:
    driver: bridge  # Use bridge networking for inter-container communication

# Volumes setup (persistent storage for MongoDB)
volumes:
  mongo:
    driver: local  # Use local storage for MongoDB data persistence
